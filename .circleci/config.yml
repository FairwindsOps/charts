version: 2.1

orbs:
  rok8s: fairwinds/rok8s-scripts@14

references:
  setup_environment: &setup_environment
    run:
      name: Setup Environment
      command: |
        echo 'export CI_SHA1=$CIRCLE_SHA1' >> ${BASH_ENV}
        echo 'Install AWS CLI'
        apk --no-cache add aws-cli
        echo 'Install needed packages'
        apk --no-cache add bash jq curl yq

  check_changelog: &check_changelog
    run:
      name: Check CHANGELOG
      command: |
        require_changelog=( insights-agent fairwinds-insights insights-admission )
        for chart in "${require_changelog[@]}"; do
          version=$(yq eval '.version' ./stable/$chart/Chart.yaml )
          echo "Checking if CHANGELOG.md is updated for $chart"
          grep "## $version" ./stable/$chart/CHANGELOG.md
        done

  install_vault_alpine: &install_vault_alpine
    run:
      name: install hashicorp vault
      command: |
        apk --update add curl yq
        cd /tmp
        curl -LO https://releases.hashicorp.com/vault/1.13.2/vault_1.13.2_linux_amd64.zip
        sha256sum vault_1.13.2_linux_amd64.zip | grep f7930279de8381de7c532164b4a4408895d9606c0d24e2e9d2f9acb5dfe99b3c
        unzip vault_1.13.2_linux_amd64.zip
        mv vault /usr/bin/vault

  kind_configuration_helm3: &kind_configuration_helm3
    pre_script: scripts/circle-pre-e2e.sh
    script: scripts/circle-e2e.sh
    command_runner_image: quay.io/helmpack/chart-testing:v3.14.0
    requires:
      - lint-scripts
      - lint-charts
      - check-helm-docs
    filters:
      branches:
        only: /.*/
      tags:
        ignore: /.*/

executors:
  ci-images:
    docker:
      - image: quay.io/reactiveops/ci-images:v14.1-bullseye
  ci-images-xlarge:
    resource_class: xlarge
    docker:
      - image: quay.io/reactiveops/ci-images:v14.1-bullseye

jobs:
  check-helm-docs:
    executor: ci-images
    steps:
      - checkout
      - run:
          name: Install helm-docs
          command: |
            cd /tmp
            curl -LO https://github.com/norwoodj/helm-docs/releases/download/v1.11.0/helm-docs_1.11.0_Linux_x86_64.tar.gz
            tar -zxvf helm-docs_1.11.0_Linux_x86_64.tar.gz
            mv helm-docs /usr/local/bin/helm-docs
            chmod +x /usr/local/bin/helm-docs
      - run:
          name: Check Docs for Changes
          command: |
            helm-docs --sort-values-order=file
            git diff --exit-code
      - *check_changelog
  lint-scripts:
    docker:
      - image: koalaman/shellcheck-alpine:v0.7.0
    steps:
      - checkout
      - run:
          name: lint
          command: |
            for script in $(ls scripts/*.sh); do
                shellcheck -x $script
            done
      - run:
          name: lint-pre-scripts
          command: |
            for script in $(find incubator stable -type f -name pre-test-script.sh); do
                shellcheck -x $script
            done
  lint-charts:
    docker:
      - image: quay.io/helmpack/chart-testing:v3.14.0
    steps:
      - checkout
      - *setup_environment
      - run:
          name: lint
          command: |
            git remote add ro https://github.com/fairwindsops/charts
            git fetch ro master
            ct lint --config scripts/ct.yaml --chart-yaml-schema scripts/schema.yaml --debug --print-config

  sync:
    docker:
      - image: quay.io/helmpack/chart-testing:v3.14.0
    steps:
      - checkout
      - *setup_environment
      - *install_vault_alpine
      - rok8s/get_vault_aws_credentials:
          vault_path: fairwindsops/sts/charts-docs
      - rok8s/get_vault_env:
          vault_path: repo/charts/env
      - run:
          name: sync
          command: scripts/sync.sh

workflows:
  version: 2
  test-and-sync:
    jobs:
      - check-helm-docs
      - lint-scripts
      - lint-charts
      - rok8s/kubernetes_e2e_tests:
          name: "End-To-End Kubernetes 1.32"
          kind_node_image: "kindest/node:v1.32.11@sha256:5fc52d52a7b9574015299724bd68f183702956aa4a2116ae75a63cb574b35af8"
          checkout-method: full
          executor:
            name: ci-images-xlarge
          <<: *kind_configuration_helm3
      - rok8s/kubernetes_e2e_tests:
          name: "End-To-End Kubernetes 1.33"
          kind_node_image: "kindest/node:v1.33.7@sha256:d26ef333bdb2cbe9862a0f7c3803ecc7b4303d8cea8e814b481b09949d353040"
          checkout-method: full
          executor:
            name: ci-images-xlarge
          <<: *kind_configuration_helm3
      - rok8s/kubernetes_e2e_tests:
          name: "End-To-End Kubernetes 1.34"
          kind_node_image: "kindest/node:v1.34.3@sha256:08497ee19eace7b4b5348db5c6a1591d7752b164530a36f855cb0f2bdcbadd48"
          checkout-method: full
          executor:
            name: ci-images-xlarge
          <<: *kind_configuration_helm3
      - rok8s/kubernetes_e2e_tests:
          name: "End-To-End Kubernetes 1.35"
          kind_node_image: "kindest/node:v1.35.0@sha256:4613778f3cfcd10e615029370f5786704559103cf27bef934597ba562b269661"
          checkout-method: full
          executor:
            name: ci-images-xlarge
          <<: *kind_configuration_helm3
      - sync:
          requires:
            - lint-scripts
            - lint-charts
            - check-helm-docs
          filters:
            branches:
              only:
                - master
