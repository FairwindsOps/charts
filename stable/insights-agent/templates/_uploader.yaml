{{- define "uploaderContainer" }}
- name: insights-uploader
  image: "{{ .Values.uploader.image.repository }}:{{ .Values.uploader.image.tag }}"
  imagePullPolicy: Always
  {{- with $.Values.uploader.imagePullSecret }}
  imagePullSecrets:
  - name: {{ . }}
  {{- end }}
  command:
  - ./uploader.sh
  - --datatype
  - {{ .Label }}
  {{- with .Config.timeout }}
  - --timeout
  - "{{ . }}"
  {{- end }}
  - --organization
  - {{ required "You must set an organization" .Values.insights.organization | quote }}
  - --cluster
  - {{ required "You must set a cluster" .Values.insights.cluster | quote }}
  {{- with .Values.insights.host }}
  - --host
  - {{ . | quote }}
  {{- end }}
  - --version
  - {{ .Config.image.tag | quote }}
  - --file
  - /output/{{ .Label }}.json
  env:
  - name: FAIRWINDS_TOKEN
    valueFrom:
      secretKeyRef:
        {{ if .Values.insights.tokenSecretName -}}
        name: {{ .Values.insights.tokenSecretName }}
        {{ else -}}
        name: {{ include "insights-agent.fullname" . }}-token
        {{ end -}}
        key: token
  - name: FAIRWINDS_AGENT_CHART_VERSION
    value: {{ .Chart.Version }}
  - name: SEND_FAILURES
    value: {{ .Values.uploader.sendFailures | quote }}
  - name: POD_NAME
    valueFrom:
      fieldRef:
        fieldPath: metadata.name
  {{- with .Values.uploader.env }}
  {{- toYaml . | nindent 2 }}
  {{- end }}
  {{ include "proxy-env-spec" . | indent 2 | trim }}
  {{ include "ssl-cert-file-env-spec" . | indent 2 | trim }}

  volumeMounts:
  - name: output
    mountPath: /output
{{ include "ssl-cert-file-volumemount-spec" . | indent 2 }}
  resources:
    {{- toYaml .Values.uploader.resources | nindent 4 }}
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    privileged: false
    capabilities:
      drop:
        - ALL
{{- end }}
