{{- define "uploaderContainer" }}
- name: fairwinds-agent
  image: "{{ .Values.uploader.image.repository }}:{{ .Values.uploader.image.tag }}"
  imagePullPolicy: Always
  command:
  - ./agent.sh
  - --datatype
  - {{ .Label }}
  {{- with .Config.timeout }}
  - --timeout
  - "{{ . }}"
  {{- end }}
  - --organization
  - {{ .Values.insights.organization | quote }}
  - --cluster
  - {{ .Values.insights.cluster | quote }}
  {{- with .Values.insights.host }}
  - --host
  - {{ . }}
  {{- end }}
  - --version
  - {{ .Config.image.tag | quote }}
  - --file
  - /output/{{ .Label }}.json
  env:
  - name: FAIRWINDS_TOKEN
    valueFrom:
      secretKeyRef:
        name: fairwinds-agent-token
        key: token
  - name: FAIRWINDS_AGENT_CHART_VERSION
    value: {{ .Chart.Version }}
  volumeMounts:
  - name: output
    mountPath: /output
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 100m
      memory: 128Mi
  securityContext:
    allowPrivilegeEscalation: false
    privileged: false
    capabilities:
      drop:
        - ALL
{{- end }}
