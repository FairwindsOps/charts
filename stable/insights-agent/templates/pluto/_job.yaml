{{- define "pluto.job.spec" -}}
restartPolicy: Never
serviceAccountName: {{ include "insights-agent.fullname" . }}-pluto
volumes:
- name: output
  emptyDir: {}
containers:
- name: pluto-audit
  image: "{{ .Values.pluto.image.repository }}:{{ .Values.pluto.image.tag }}"
  imagePullPolicy: Always
  command: ["/bin/sh", "-c"]
  args: ["/pluto detect-helm -ojson > /output/pluto-tmp.json; mv /output/pluto-tmp.json /output/pluto.json"]
  volumeMounts:
  - name: output
    mountPath: /output
  resources:
    {{- toYaml .Values.pluto.resources | nindent 4 }}
  securityContext:
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    runAsNonRoot: true
    runAsUser: 10324
    capabilities:
      drop:
        - ALL
{{- $_ := set . "Label" "pluto" }}
{{- $_ := set . "Config" .Values.pluto }}
{{- include "uploaderContainer" . }}
{{- end }}
