{{- if .Values.opa.enabled -}}
apiVersion: insights.fairwinds.com/v1beta1
kind: CustomCheck
metadata:
  name: must-have-hpa
spec:
  output:
    title: "HPA is required"
    severity: 0.1
    remediation: "Create an HPA"
    category: "Reliability"
  additionalKubernetesData: # At the Check level because this changes how you write the rego.
  - apiGroups: ["autoscaling"]
    kinds: ["HorizontalPodAutoscaler"]
  rego: |
         package fairwinds
         contains(hpas, elem) {
           hpa := hpas[_]
           hpa.spec.scaleTargetRef.kind == elem.kind
           hpa.spec.scaleTargetRef.name == elem.metadata.name
           hpa.spec.scaleTargetRef.apiVersion == elem.apiVersion
         }
         hparequired[description] {
           not contains(kubernetes("HorizontalPodAutoscaler"), input)
           description := "No horizontal pod autoscaler found"
         }
{{- end -}}
