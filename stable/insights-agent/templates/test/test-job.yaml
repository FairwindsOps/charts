apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "insights-agent.fullname" . }}
  labels:
    {{- include "insights-agent.labels" . | nindent 4 }}
    component: test-job
  annotations:
    "helm.sh/hook": test
spec:
  template:
    spec:
      serviceAccountName: {{ include "insights-agent.fullname" . }}-cronjob-exector
      restartPolicy: Never
      containers:
      - command:
        - sh
        args:
        - -c
        - |
          kubectl get cj --selector=app=insights-agent -o custom-columns=NAME:.metadata.name --no-headers | xargs -I~job~ kubectl wait --for=condition=complete job/~job~ --timeout=480s
          exit 1
        image: '{{.Values.cronjobExector.image.repository}}:{{.Values.cronjobExector.image.tag}}'
        imagePullPolicy: Always
        name: test
        resources:
          limits:
            cpu: 1
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 128Mi
        securityContext:
          allowPrivilegeEscalation: false
          privileged: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          capabilities:
            drop:
              - ALL
