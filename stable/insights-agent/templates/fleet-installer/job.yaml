{{- if .Values.fleetInstall -}}
{{- $_ := set . "Label" "fleet-installer" }}
apiVersion: batch/v1
kind: Job
metadata:
  {{- include "metadata" . }}
    "helm.sh/hook-weight": "10"
    "helm.sh/hook": pre-install
    # "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
spec:
  ttlSecondsAfterFinished: 3000
  backoffLimit: {{ .Values.cronjobs.backoffLimit }}
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "insights-agent.fullname" . }}-fleet-installer
      containers:
      - name: fleet-installer
        image: "{{ .Values.cronjobExecutor.image.repository }}:{{ .Values.cronjobExecutor.image.tag }}"
        imagePullPolicy: Always
        command: ["sh"]
        args:
          - -c
          - |
            echo "start!"
            AUTH_HEADER="Authorization: Bearer $ADMIN_TOKEN"
            echo "Auth $AUTH_HEADER"
            CLUSTER_URL="{{ .Values.insights.host }}/v0/organizations/{{ .Values.insights.organization }}/clusters/{{ .Values.insights.cluster }}"
            echo "url $CLUSTER_URL"
            EXISTS=$(curl -s -o /dev/null -w "%{http_code}" "$CLUSTER_URL" -H "$AUTH_HEADER")
            echo "Cluster exists? $EXISTS"
            if [[ $EXISTS -eq 404 ]]; then
              echo "Creating cluster..."
              RESP=$(curl -X POST "$CLUSTER_URL" -H "$AUTH_HEADER")
              CLUSTER_TOKEN=$(echo $RESP | sed 's/^.*"AuthToken":"\([^{"}]*\)".*$/\1/')
              kubectl create secret generic \
                --from-literal="token=$CLUSTER_TOKEN" \
                -n {{ .Release.Namespace }} \
                {{ include "insights-agent.fullname" . }}-token
              echo "Created secret with auth token"
            fi

        resources:
          {{- toYaml .Values.cronjobExecutor.resources | nindent 10 }}
        env:
          - name: ADMIN_TOKEN
            valueFrom:
              secretKeyRef:
                name:  {{ include "insights-agent.fullname" . }}-admin-token
                key: token
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        securityContext:
          runAsUser: 1000
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          privileged: false
          runAsNonRoot: true
          capabilities:
            drop:
              - ALL
      volumes:
      - name: tmp
        emptyDir: {}
{{- end -}}
