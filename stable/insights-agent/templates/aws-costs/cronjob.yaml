{{- if .Values.awscosts.enabled -}}
{{- $_ := set . "Label" "awscosts" }}
{{- $_ := set . "Config" .Values.awscosts }}
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  {{- include "metadata" . }}
spec:
  {{ include "cronjob-spec" . | nindent 2 | trim }}
  jobTemplate:
    spec:
      {{ include "job-spec" . | nindent 6 | trim }}
      template:
        spec:
          {{ include "job-template-spec" . | indent 10 | trim }}
          containers:
          - {{ include "container-spec" . | indent 12 | trim }}
            env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.awscosts.secretName }}
                  key: AWS_ACCESS_KEY_ID
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.awscosts.secretName }}
                  key: AWS_SECRET_ACCESS_KEY            
            - name: AWS_DEFAULT_REGION
              value: {{ .Values.awscosts.region }}
            command: ["/bin/sh", "-c"]
            args: ["/aws-costs --cluster {{ .Values.awscosts.clusterName }}"]
            {{ include "security-context" . | indent 12 | trim }}
          {{ include "uploaderContainer" . | indent 10 | trim }}
  {{- end -}}