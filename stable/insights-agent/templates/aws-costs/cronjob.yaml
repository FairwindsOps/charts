{{ if has "awscosts" .Values }}
{{ fail "awscosts has been renamed to aws-costs in version 2.0. See breaking changes at https://github.com/FairwindsOps/charts/blob/master/stable/insights-agent/CHANGELOG.md" }}
{{ end }}
{{- if (index .Values "aws-costs" "enabled") -}}
{{- $_ := set . "Label" "awscosts" }} #TODO(Barnie): change to aws-cost once the backend is fixed for this
{{- $_ := set . "Config" (index .Values "aws-costs")}}
{{- if not (.Capabilities.APIVersions.Has "batch/v1/CronJob") }}
apiVersion: batch/v1beta1
{{- else }}
apiVersion: batch/v1
{{- end }}
kind: CronJob
metadata:
  {{- include "metadata" . }}
spec:
  {{ include "cronjob-spec" . | nindent 2 | trim }}
  jobTemplate:
    spec:
      {{ include "job-spec" . | nindent 6 | trim }}
      template:
        spec:
          {{ include "job-template-spec" . | indent 10 | trim }}
          containers:
          - {{ include "container-spec" . | indent 12 | trim }}
            env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: {{ (index .Values "aws-costs" "secretName") }}
                  key: AWS_ACCESS_KEY_ID
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ (index .Values "aws-costs" "secretName") }}
                  key: AWS_SECRET_ACCESS_KEY            
            - name: AWS_DEFAULT_REGION
              value: {{ (index .Values "aws-costs" "region") }}
            command: ["./aws-costs.sh"]
            args:
              - --database 
              - {{ (index .Values "aws-costs" "database") }}
              - --table 
              - {{ (index .Values "aws-costs" "table") }}
              - --catalog 
              - {{ (index .Values "aws-costs" "catalog") }}
              - --tagkey 
              - {{ (index .Values "aws-costs" "tagkey") }}
              - --tagvalue 
              - {{ (index .Values "aws-costs" "tagvalue") }}
              - --workgroup 
              - {{ (index .Values "aws-costs" "workgroup") }}              
            {{ include "security-context" . | indent 12 | trim }}
          {{ include "uploaderContainer" . | indent 10 | trim }}
  {{- end -}}