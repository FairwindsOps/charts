{{- if .Values.options.autogenerateKeys }}
apiVersion: v1
data:
    COOKIE_HASH_KEY: {{ randAlphaNum 64 | b64enc }}
    COOKIE_BLOCK_KEY: {{ randAlphaNum 32 | b64enc }}
    SESSION_AUTH_KEY: {{ randAlphaNum 64 | b64enc }}
    SESSION_ENCRYPTION_KEY: {{ randAlphaNum 32 | b64enc }}
    AES_BASE64_CYPHER_KEY: {{ default (randAlphaNum 32) .Values.encryption.aes.cypherKey | b64enc }}
kind: Secret
metadata:
    name: {{ .Values.options.secretName }}
type: Opaque
{{- end }}
---
{{- if .Values.postgresql.ephemeral }}
apiVersion: v1
data:
    {{- $password := b64enc (default (randAlphaNum 32) .Values.postgresql.auth.password) }}
    password: {{ $password }}
    postgresql-password: {{ $password }}
    username: {{ b64enc .Values.postgresql.auth.username }}
kind: Secret
metadata:
    name: fwinsights-postgresql
type: Opaque
---
apiVersion: v1
data:
    username: {{ b64enc "postgres" }}
    password: {{ b64enc (default (randAlphaNum 32) .Values.postgresql.auth.superuserpassword) }}
kind: Secret
metadata:
    name: fwinsights-postgresql-superuser
type: Opaque
{{- end }}
---
{{- if .Values.timescale.ephemeral }}
{{- $existingTsSecret := lookup "v1" "Secret" .Release.Namespace .Values.timescale.auth.existingSecret }}
{{- $tsPassword := "" }}
{{- if and $existingTsSecret $existingTsSecret.data (not .Values.timescale.password) }}
{{- $tsPassword = index $existingTsSecret.data "password" | b64dec }}
{{- else }}
{{- $tsPassword = default (randAlphaNum 32) .Values.timescale.password }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
    name: {{ .Values.timescale.auth.existingSecret }}
type: Opaque
data:
    username: {{ b64enc .Values.timescale.postgresqlUsername }}
    password: {{ b64enc $tsPassword }}
---
apiVersion: v1
kind: Secret
metadata:
    name: {{ .Values.timescale.auth.existingSuperUserSecret }}
type: Opaque
data:
    username: {{ b64enc "postgres" }}
    password: {{ b64enc $tsPassword }}
{{- end }}
---
{{- if .Values.postgresql.ephemeral }}
apiVersion: v1
kind: Secret
metadata:
    name: fwinsights-postgresql-ca
type: kubernetes.io/tls
{{ $ca := genCA "postgres" 1826 -}}
stringData:
    tls.crt: {{ $ca.Cert | quote }}
    tls.key: {{ $ca.Key  | quote }}
{{- end }}
---
