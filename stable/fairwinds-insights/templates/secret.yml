{{- if .Values.options.autogenerateKeys }}
apiVersion: v1
data:
    COOKIE_HASH_KEY: {{ randAlphaNum 64 | b64enc }}
    COOKIE_BLOCK_KEY: {{ randAlphaNum 32 | b64enc }}
    SESSION_AUTH_KEY: {{ randAlphaNum 64 | b64enc }}
    SESSION_ENCRYPTION_KEY: {{ randAlphaNum 32 | b64enc }}
    AES_BASE64_CYPHER_KEY: {{ default (randAlphaNum 32) .Values.encryption.aes.cypherKey | b64enc }}
kind: Secret
metadata:
    name: {{ .Values.options.secretName }}
type: Opaque
{{- end }}
---
{{- if .Values.postgresql.ephemeral }}
apiVersion: v1
data:
    postgresql-password: {{ default (randAlphaNum 32) .Values.postgresql.auth.password | b64enc }}
kind: Secret
metadata:
    name: fwinsights-postgresql
type: Opaque
{{- end }}
---
{{- if .Values.timescale.ephemeral }}
apiVersion: v1
kind: Secret
metadata:
    name: fwinsights-timescale
type: Opaque
stringData:
    PATRONI_SUPERUSER_PASSWORD: {{ default (randAlphaNum 32) .Values.timescale.password }}
    PATRONI_REPLICATION_PASSWORD: {{ default (randAlphaNum 32) .Values.timescale.password }}
    PATRONI_admin_PASSWORD: {{ default (randAlphaNum 32) .Values.timescale.password }}
{{- end }}
---
{{- if .Values.timescale.ephemeral }}
apiVersion: v1
kind: Secret
metadata:
    name: fwinsights-timescale-ca
type: kubernetes.io/tls
{{ $ca := genCA (include "clusterName" .) 1826 -}}
stringData:
    tls.crt: {{ $ca.Cert | quote }}
    tls.key: {{ $ca.Key  | quote }}
{{- end }}
---
{{- if .Values.postgresql.ephemeral }}
apiVersion: v1
kind: Secret
metadata:
    name: fwinsights-postgresql-ca
type: kubernetes.io/tls
{{ $ca := genCA (include "clusterName" .) 1826 -}}
stringData:
    tls.crt: {{ $ca.Cert | quote }}
    tls.key: {{ $ca.Key  | quote }}
{{- end }}
---
{{- if .Values.existingSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ template "minio.secretName" . }}
  namespace: {{ .Release.Namespace | quote }}
  labels:
    app: {{ template "minio.name" . }}
    chart: {{ template "minio.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
type: Opaque
data:
  rootUser: {{ include "minio.root.username" . | b64enc | quote }}
  rootPassword: {{ include "minio.root.password" . | b64enc | quote }}
  accesskey: ""
  secretkey: ""
{{- end }}

{{- define "minio.name" -}}
{{- default .Chart.Name .Values.minio.nameOverride | trunc 63 | trimSuffix "-" -}}
{{- end -}}

{{/*
Returns the available value for certain key in an existing secret (if it exists),
otherwise it generates a random value.
*/}}
{{- define "minio.getValueFromSecret" }}
  {{- $len := (default 16 .Length) | int -}}
  {{- $obj := (lookup "v1" "Secret" .Namespace .Name).data -}}
  {{- if $obj }}
      {{- index $obj .Key | b64dec -}}
  {{- else -}}
      {{- randAlphaNum $len -}}
  {{- end -}}
{{- end }}

{{/*
Create chart name and version as used by the chart label.
*/}}
{{- define "minio.chart" -}}
{{- printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" -}}
{{- end -}}

{{/*
Determine secret name.
*/}}
{{- define "minio.secretName" -}}
{{- if .Values.existingSecret -}}
{{ template "minio.secretName" . }}
{{- else -}}
{{- include "minio.fullname" . -}}
{{- end -}}
{{- end -}}

{{- define "minio.root.username" -}}
  {{- if .Values.minio.rootUser }}
    {{- .Values.minio.rootUser | toString }}
  {{- else }}
    {{- include "minio.getValueFromSecret" (dict "Namespace" .Release.Namespace "Name" (include "minio.fullname" .) "Length" 20 "Key" "rootUser") }}
  {{- end }}
{{- end -}}

{{- define "minio.root.password" -}}
  {{- if .Values.minio.rootPassword }}
    {{- .Values.minio.rootPassword | toString }}
  {{- else }}
    {{- include "minio.getValueFromSecret" (dict "Namespace" .Release.Namespace "Name" (include "minio.fullname" .) "Length" 40 "Key" "rootPassword") }}
  {{- end }}
{{- end -}}

{{- define "minio.fullname" -}}
{{- if .Values.minio.fullnameOverride -}}
{{- .Values.minio.fullnameOverride | trunc 63 | trimSuffix "-" -}}
{{- else -}}
{{- $name := default .Chart.Name .Values.minio.nameOverride -}}
{{- if contains $name .Release.Name -}}
{{- .Release.Name | trunc 63 | trimSuffix "-" -}}
{{- else -}}
{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" -}}
{{- end -}}
{{- end -}}
{{- end -}}